apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
    app.kubernetes.io/component: database
    app.kubernetes.io/managed-by: helm
data:
  10-create-user-and-dbs.sql: |
    {{- range $user := .Values.users }}
    CREATE USER {{ $user.name }} WITH PASSWORD '{{ $user.password }}';
    {{- end }}

    {{- range $database := .Values.datases }}
    CREATE DATABASE {{ $database.name }};
    GRANT ALL PRIVILEGES ON DATABASE {{ $database.name }} TO {{ $database.user }};
  {{- end }}
  20-grant-privileges-to-public.sh: |
    export PGPASSWORD={{ .Values.defaultDatabase.password }}
    {{- range $database := .Values.datases }}
    psql -U {{ $.Values.defaultDatabase.user }} -d {{ $database.name }} -c "GRANT ALL PRIVILEGES ON SCHEMA public TO {{ $database.user }};"
    {{ end }}
